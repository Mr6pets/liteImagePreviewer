# 核心功能详解

<cite>
**本文档引用的文件**  
- [imageManager.js](file://js/imageManager.js)
- [viewer.js](file://js/viewer.js)
- [editor.js](file://js/editor.js)
- [dragUpload.js](file://js/dragUpload.js)
- [themes.js](file://themes.js)
- [eventHandler.js](file://js/eventHandler.js)
- [ui.js](file://js/ui.js)
- [core.js](file://js/core.js)
</cite>

## 目录
1. [图片管理功能](#图片管理功能)
2. [图片预览机制](#图片预览机制)
3. [图像编辑能力](#图像编辑能力)
4. [拖拽上传实现](#拖拽上传实现)
5. [主题切换管理](#主题切换管理)
6. [事件处理逻辑](#事件处理逻辑)

## 图片管理功能

该模块由 `ImageManager` 类实现，负责图片的上传、加载、存储、删除与清空操作。通过 `handleFileSelect` 方法响应文件输入控件的 `change` 事件，读取用户选择的图片文件，并使用 `FileReader` 将其转换为 Data URL 格式进行预览。所有图片信息以对象形式存储在 `images` 数组中，包含名称、大小、类型、原始数据及滤镜设置等元数据。

当用户上传图片时，系统会检查是否已存在同名文件，避免重复添加。每张图片被封装为一个 `.image-item` DOM 元素，包含缩略图、文件名、大小信息和删除按钮。点击缩略图可触发预览功能，进入全屏查看模式。删除单张图片时，系统会确认操作并释放相关资源（如 Blob URL），同时更新界面状态。当图片列表为空时，显示空状态提示并隐藏清空按钮。

**Section sources**
- [imageManager.js](file://js/imageManager.js#L1-L196)
- [ui.js](file://js/ui.js#L1-L126)

## 图片预览机制

`ImageViewer` 类负责实现图片的全屏预览功能，支持缩放、旋转、平移和全屏切换。用户可通过点击缩略图或使用键盘方向键切换图片。缩放通过 `zoomIn` 和 `zoomOut` 方法实现，基于 CSS `transform: scale()` 进行视觉放大缩小，最大支持5倍，最小0.1倍。旋转功能支持左右各90度旋转，通过 `rotateLeft` 和 `rotateRight` 方法更新 `rotation` 属性并应用变换。

图片拖拽平移功能通过监听 `mousedown`、`mousemove` 和 `mouseup` 事件实现，使用 `requestAnimationFrame` 优化拖拽性能，确保流畅体验。鼠标滚轮可用于快速缩放，系统会检测事件目标是否在编辑面板内，避免误操作。全屏模式通过调用 `requestFullscreen()` 实现，兼容现代浏览器。预览界面支持点击背景关闭，提升用户体验。

**Section sources**
- [viewer.js](file://js/viewer.js#L1-L153)
- [eventHandler.js](file://js/eventHandler.js#L1-L214)

## 图像编辑能力

图像编辑功能由 `ImageEditor` 类提供，支持亮度、对比度、饱和度调节及多种滤镜应用（灰度、怀旧、反色、模糊）。编辑面板通过 `toggleEditPanel` 方法控制显隐，进入编辑模式时保存当前图片原始滤镜状态，以便取消操作时恢复。

裁剪功能通过 `toggleCropMode` 启用，创建一个可拖拽和调整大小的裁剪框（`.crop-box`），结合 `_crop.scss` 样式实现视觉反馈。用户可拖动四角手柄调整裁剪区域，最终通过 Canvas 绘制生成新图片并替换原图。水印功能支持文字和图片叠加，通过 `toggleWatermarkMode` 激活，用户可输入文字、选择颜色、字体大小和样式（阴影、描边、透明），并通过拖拽定位水印位置。水印应用时使用 Canvas 合成图像，确保效果持久化。

**Section sources**
- [editor.js](file://js/editor.js#L1-L754)
- [_crop.scss](file://src/scss/_crop.scss)
- [_watermark.scss](file://src/scss/_watermark.scss)

## 拖拽上传实现

`DragUploadManager` 类实现了完整的拖拽上传功能。通过监听 `dragenter`、`dragover`、`dragleave` 和 `drop` 事件，阻止默认行为并添加视觉反馈。当用户将图片文件拖入页面时，触发 `handleDrop` 方法，过滤出图片类型文件并调用 `ImageManager` 的 `processFiles` 方法进行处理。

拖拽过程中，页面会显示高亮效果和提示层（`.drag-overlay`），包含动画图标和说明文字，提升交互体验。上传成功后，系统会显示一个持续3秒的反馈提示（`.upload-feedback`），告知用户已成功添加图片。整个过程无需刷新页面，实现无缝上传体验。

**Section sources**
- [dragUpload.js](file://js/dragUpload.js#L1-L218)
- [eventHandler.js](file://js/eventHandler.js#L1-L214)

## 主题切换管理

`ThemeManager` 类负责管理应用的主题切换功能，支持默认、暗黑、海洋、日落、森林五种主题。主题配置以对象形式定义在 `themes` 变量中，包含名称、图标和颜色方案。用户可通过右上角主题选择器切换主题，选择结果保存在 `localStorage` 中，实现持久化记忆。

切换主题时，系统动态更新 CSS 自定义属性（如 `--primary-color`、`--card-bg` 等），并重新设置页面背景、文本颜色和组件样式。标题文字采用渐变色和背景剪裁技术实现炫彩效果，不同主题对应不同的渐变方案。主题按钮带有悬停动画和下拉菜单，提供直观的操作反馈。

**Section sources**
- [themes.js](file://themes.js#L1-L365)
- [core.js](file://js/core.js#L1-L28)

## 事件处理逻辑

`EventHandler` 类集中管理所有用户交互事件，将 UI 操作映射到核心功能调用。通过 `bindEvents` 方法绑定文件输入、按钮点击、键盘输入、鼠标拖拽等事件。例如，文件选择事件触发 `ImageManager.handleFileSelect`，缩放按钮调用 `Viewer.zoomIn/zoomOut`，键盘 `+/-` 键对应缩放操作，`Esc` 键用于逐级退出裁剪、水印、编辑或预览模式。

键盘快捷键设计充分考虑用户习惯，如方向键切换图片、`R` 键旋转、`F` 键全屏、`D` 键下载、`E/C/W` 键分别进入编辑、裁剪、水印模式。删除键（Delete/Backspace）可直接移除当前图片。所有事件处理均检查当前状态（如是否处于编辑模式），避免冲突操作。下载功能通过 Canvas 生成带编辑效果的图片 Blob，并自动触发下载，文件名追加 `_edited` 后缀。

**Section sources**
- [eventHandler.js](file://js/eventHandler.js#L1-L214)
- [core.js](file://js/core.js#L1-L28)