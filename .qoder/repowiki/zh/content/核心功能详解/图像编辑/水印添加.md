# 水印添加

<cite>
**本文档中引用的文件**  
- [editor.js](file://js/editor.js)
- [_watermark.scss](file://src/scss/_watermark.scss)
- [index.html](file://index.html)
</cite>

## 目录
1. [简介](#简介)
2. [水印DOM元素创建与状态管理](#水印dom元素创建与状态管理)
3. [用户输入处理与样式应用](#用户输入处理与样式应用)
4. [_watermark.scss样式层分析](#_watermarkscss样式层分析)
5. [Canvas水印渲染机制](#canvas水印渲染机制)
6. [水印位置预设与拖拽定位](#水印位置预设与拖拽定位)
7. [常见问题调试与兼容性说明](#常见问题调试与兼容性说明)

## 简介
`liteImagePreviewer` 是一个现代化的轻量级图片预览器，支持图像编辑功能，其中水印功能是其核心特性之一。本文档详细解析该系统中文字与图片水印的实现原理，涵盖从DOM结构创建、用户交互处理、样式管理到最终Canvas渲染的完整流程。重点分析 `editor.js` 如何管理水印显示状态、响应用户输入，并结合 `_watermark.scss` 探讨水印层的定位机制与响应式设计。

## 水印DOM元素创建与状态管理

`ImageEditor` 类通过 `toggleWatermarkMode` 方法控制水印功能的开启与关闭。当用户点击“添加水印”按钮时，该方法被调用，将 `watermarkMode` 状态设为 `true`，并显示 `#watermarkOverlay` 覆盖层。

水印的DOM元素在 `initWatermark` 方法中初始化，通过 `querySelector` 获取 `.watermark-text` 元素的引用。此元素在 `index.html` 中定义为一个位于 `#watermarkOverlay` 内的 `div`，其 `contenteditable="true"` 属性允许直接在界面上编辑文本。

水印的显示状态由 `watermarkMode` 布尔值和 `#watermarkOverlay` 的CSS `display` 属性共同管理。进入水印模式时，`addWatermarkEventListeners` 绑定所有相关事件；退出时，`removeWatermarkEventListeners` 解绑事件，并重置水印元素的位置和变换样式，确保下次进入时恢复初始状态。

**Section sources**
- [editor.js](file://js/editor.js#L466-L500)
- [index.html](file://index.html#L110-L112)

## 用户输入处理与样式应用

系统通过事件监听机制实时响应用户对水印内容、字体、大小、颜色和透明度的修改。

- **内容更新**：`watermarkInput` 输入框的 `input` 事件触发 `updateWatermarkText` 方法，将输入框的值同步到 `watermarkText` 元素的 `textContent`。
- **样式更新**：`updateWatermarkStyle` 方法集中处理颜色、大小和预设样式（阴影、描边、半透明）的变更。该方法在 `watermarkStyle`、`watermarkColor` 和 `watermarkSize` 元素的相应事件（`change` 或 `input`）触发时被调用。
- **大小更新**：`updateWatermarkSize` 方法不仅更新字体大小，还同步更新UI上的滑块值显示。

所有事件监听器均在 `addWatermarkEventListeners` 中统一注册，并在退出模式时通过 `removeWatermarkEventListeners` 安全移除，防止内存泄漏。

**Section sources**
- [editor.js](file://js/editor.js#L502-L555)
- [index.html](file://index.html#L122-L140)
- [eventHandler.js](file://js/eventHandler.js#L83-L93)

## _watermark.scss样式层分析

`_watermark.scss` 文件定义了水印功能的全部CSS样式，其设计确保了水印层的正确叠加和交互性。

- **定位机制**：`.watermark-overlay` 使用 `position: absolute` 覆盖在图片容器之上，`z-index: 10` 确保其位于图片和其他控件之上。`.watermark-text` 使用 `position: absolute` 结合 `top: 50%`、`left: 50%` 和 `transform: translate(-50%, -50%)` 实现居中定位。
- **层级控制**：`pointer-events: none` 应用于 `.watermark-overlay`，允许鼠标事件穿透到下层元素。但 `.watermark-text` 设置为 `pointer-events: auto`，使其能够响应拖拽操作。
- **响应式设计**：通过 `user-select: none` 防止文本被意外选中，`cursor: move` 提供拖拽视觉反馈。样式变量（如颜色、字体）通过SCSS变量（如 `variables.$primary-color`）引入，便于主题化。

**Section sources**
- [_watermark.scss](file://src/scss/_watermark.scss#L1-L91)

## Canvas水印渲染机制

当用户点击“应用水印”时，`applyWatermark` 方法执行最终的渲染。

1.  **创建Canvas**：创建一个 `canvas` 元素，并获取其2D上下文 `ctx`。
2.  **加载基础图像**：创建一个 `Image` 对象加载当前图片的原始数据（`originalSrc`），以保证最高质量。
3.  **绘制基础图像**：在 `onload` 回调中，将基础图像完整绘制到Canvas上。
4.  **计算缩放比例**：根据图像的自然尺寸（`naturalWidth/Height`）和显示尺寸（`getBoundingClientRect`）计算 `scaleX` 和 `scaleY`，确保水印大小与图像分辨率匹配。
5.  **确定水印位置**：
    - 如果用户拖拽过水印，则使用其 `left` 和 `top` 值乘以缩放比例，得到Canvas坐标。
    - 否则，使用居中定位（`canvas.width / 2`, `canvas.height / 2`）。
6.  **应用水印样式**：
    - **文本绘制**：使用 `ctx.font`、`ctx.fillStyle` 和 `ctx.globalAlpha` 设置字体、颜色和透明度。
    - **阴影**：通过 `ctx.shadowColor`、`ctx.shadowBlur` 和 `ctx.shadowOffsetX/Y` 实现，其参数也根据缩放比例调整。
    - **描边**：通过 `ctx.strokeStyle` 和 `ctx.lineWidth` 设置，并调用 `strokeText` 进行描边绘制。
    - **填充**：最后调用 `fillText` 完成文本绘制。
7.  **更新图像**：将Canvas转换为Data URL，更新当前图片数据、预览图和缩略图。

**Section sources**
- [editor.js](file://js/editor.js#L596-L693)

## 水印位置预设与拖拽定位

- **预设位置**：初始位置由 `_watermark.scss` 中的居中定位规则决定，即水印默认显示在图片中央。
- **自定义拖拽定位**：
    - **开始拖拽**：`startWatermarkDrag` 方法记录鼠标起始位置和水印的初始 `left`/`top` 值。
    - **拖拽过程**：`watermarkDrag` 方法计算鼠标移动距离，并更新 `watermarkText` 的 `left` 和 `top` 样式，同时将 `transform` 设为 `none` 以覆盖初始的居中变换。
    - **结束拖拽**：`endWatermarkDrag` 方法清理状态。

此机制允许用户将水印自由拖动到任意位置，其最终坐标将被用于Canvas渲染时的定位计算。

**Section sources**
- [editor.js](file://js/editor.js#L578-L595)

## 常见问题调试与兼容性说明

- **水印偏移**：通常由缩放比例计算错误引起。确保 `applyWatermark` 中使用的 `imgRect` 是当前显示图像的矩形，且 `scaleX`/`scaleY` 计算正确。
- **水印模糊**：若Canvas尺寸与图像自然尺寸不匹配，会导致重采样模糊。应始终将Canvas尺寸设为 `naturalWidth` 和 `naturalHeight`。
- **水印不显示**：
    - 检查 `watermarkMode` 状态和 `#watermarkOverlay` 的 `display` 属性。
    - 确认 `originalSrc` 是否存在，若不存在，回退逻辑应使用 `src`。
    - 检查 `applyWatermark` 中的 `baseImg.onload` 是否被正确触发。
- **浏览器兼容性**：
    - `getComputedStyle` 和 `transform` 属性在现代浏览器中支持良好。
    - `contenteditable` 在所有主流浏览器中均受支持。
    - Canvas 2D API 是标准功能，兼容性极佳。
    - 注意 `pointer-events` 在旧版IE中的支持情况，但本项目主要面向现代浏览器。

**Section sources**
- [editor.js](file://js/editor.js#L627-L662)
- [editor.js](file://js/editor.js#L664-L693)